sudo: required
language: android
dist: bionic

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
  
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

android:
  components:
    # Uncomment the lines below if you want to
    # use the latest revision of Android SDK Tools
    - tools
    - tools
    - platform-tools

    # The BuildTools version used by your project
    - build-tools-29.0.0

    # The SDK version used to compile your project
    - android-29

    # Additional components
    - extra

    # Specify at least one system image,
    # if you need to run emulator(s) during your tests
    - sys-img-x86_64-android-29
    
before_install:
    - openssl aes-256-cbc -K $encrypted_c6f96877f600_key -iv $encrypted_c6f96877f600_iv -in volatile_keystore.jks.enc -out volatile_keystore.jks -d
    
before_script:
    - echo no | android create avd --force -n test -t android-29 --abi x86_64 -c 16000M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    
script:
    - "./gradlew clean build connectedCheck -PdisablePreDex --stacktrace"
  
before_deploy:
    - cp $TRAVIS_BUILD_DIR/.keystore $HOME
    - cd app/build/outputs/apk/
    - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/keystore.jks -storepass $storepass -keypass $storepass app-release-unsigned.apk volatile_keystore.jks
    # Verification
    - jarsigner -verify app-release-unsigned.apk
    - "${ANDROID_HOME}/build-tools/29.0.0/zipalign -v 4 app-release-unsigned.apk Quick\ Book.apk"
deploy:
  provider: releases
  file: "Quick\ Book.apk"
  skip_cleanup: true
  on:
    repo: siddhantvinchurkar/quickbook
    tags: true
  api_key: $gak
